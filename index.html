<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Kasir</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f7f7f7; }
    h1 { text-align: center; }
    .hasilCari, .keranjang, .riwayat { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4caf50; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #f1f1f1; }
    button { padding: 5px 10px; cursor: pointer; margin: 2px; border: none; border-radius: 5px; background: #4caf50; color: #fff; }
    button:hover { background: #43a047; }
    .total { margin-top: 15px; font-size: 18px; font-weight: bold; }
    .bayar { margin-top: 10px; }
    .badge { padding: 2px 6px; border-radius: 5px; color: #fff; font-size: 11px; margin-left: 4px; }
    .badge-ecer { background: #4caf50; }
    .badge-karton { background: #2196f3; }
    .badge-slop { background: #ff9800; }
    .badge-pak { background: #9c27b0; }
    .badge-sak { background: #795548; }
    .badge-bal { background: #607d8b; }
    input[type="text"], input[type="number"] { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    input[type="number"] { width: 80px; }
    .uang-rekomendasi { margin-top: 5px; }
    .uang-rekomendasi button { background: #e0e0e0; color: #000; }
    .uang-rekomendasi button:hover { background: #ccc; }
    .produk-varian { font-size: 13px; margin-left: 15px; }

    /* Notifikasi (fade in/out) */
    .notif-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      max-width: calc(100% - 32px);
    }
    .notif {
      pointer-events: auto;
      min-width: 220px;
      max-width: 420px;
      padding: 12px 14px;
      border-radius: 8px;
      color: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      opacity: 0;
      transform: translateY(-8px);
      animation: notifIn 250ms ease forwards;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .notif .icon { font-weight: 700; width: 20px; text-align: center; }
    .notif.success { background: linear-gradient(90deg,#4caf50,#43a047); }
    .notif.error { background: linear-gradient(90deg,#f44336,#e53935); }
    .notif.info  { background: linear-gradient(90deg,#2196f3,#1e88e5); }

    .notif.fade-out {
      animation: notifOut 350ms ease forwards;
    }

    @keyframes notifIn {
      from { opacity: 0; transform: translateY(-8px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes notifOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to   { opacity: 0; transform: translateY(-8px) scale(0.98); }
    }

    /* Responsive tweaks so notif doesn't overflow on small devices */
    @media (max-width: 420px) {
      .notif { min-width: 160px; font-size: 13px; padding: 10px; }
      .notif-container { left: 8px; right: 8px; top: 8px; }
    }
  </style>
</head>
<body>

<h1>Aplikasi Kasir</h1>

<input type="text" id="cariProduk" placeholder="Cari produk..." style="width:100%;padding:8px">

<div class="hasilCari">
  <h2>Hasil Pencarian</h2>
  <table id="tabelHasil">
    <thead>
      <tr>
        <th>Produk</th>
        <th>Harga</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="keranjang">
  <h2>Keranjang</h2>
  <table id="tabelKeranjang">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Varian</th>
        <th>Harga</th>
        <th>Qty</th>
        <th>Total</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="total">Total Belanja: Rp <span id="totalBelanja">0</span></div>

  <div class="bayar">
    <label>Uang Pembeli: Rp 
      <input type="text" id="uangPembeli" oninput="formatUangPembeli(this)">
    </label>
    <div class="uang-rekomendasi" id="uangRekomendasi"></div>
    <div>Kembalian: Rp <span id="kembalian">0</span></div>
  </div>

  <button onclick="cetakNota()">Cetak Nota</button>
</div>

<div class="riwayat">
  <button id="btnRiwayat" onclick="toggleRiwayat()">Riwayat Transaksi</button>
  <div id="riwayatBox" style="display:none; margin-top:10px;">
    <h2>Riwayat Transaksi</h2>
    <table id="tabelRiwayat">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Total</th>
          <th>Uang</th>
          <th>Kembali</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 🎵 Suara -->
<audio id="suaraScan" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="suaraGagal" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>

<!-- Kontainer notifikasi -->
<div class="notif-container" id="notifContainer" aria-live="polite"></div>

<script>
const produkDB = [
{
    "barcode": "",
    "nama": "Emeron Lovely handbody 400ml",
    "karton": 93000,
    "variasi": [
      {
        "nama": "Greentea",
        "barcode": "8998866109086","8998866109444"
        "harga": 8000
      }
    ],
    "isi": "12 botol"
  },
{
    "barcode": "",
    "nama": "Soklin liquid 500",
    "karton": 46500,
    "variasi": [
      {
        "nama": "Scar blos",
        "barcode": "8998866805407",
        "harga": 5000
      }
    ],
    "isi": "10 rtg"
  },
 {
    "barcode": "",
    "nama": "Indomilk milky kids",
    "karton": 90000,
    "variasi": [
      {
        "nama": "Strawbery",
        "barcode": "8993007000253",
        "harga": 2500
      },
      {
        "nama": "Coklat",
        "barcode": "8993007000239",
        "harga": 2500
      }
    ],
    "isi": "40 kotak"
  },
  {
    "barcode": "",
    "nama": "Susu tiga sapi",
    "karton": 555000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8993007002967",
        "harga": 12000
      }
    ],
    "isi": "48 klg"
  },
{
    "barcode": "",
    "nama": "Kopikap jumbo",
    "karton": 38000,
    "variasi": [],
    "isi": "24 cup"
  },
  {
    "barcode": "8999090502049",
    "nama": "Sukun ex 16",
    "slop": 257000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8999090501042",
        "harga": 26000
      }
    ],
    "isi": "10 bks"
  },
{
    "barcode": "",
    "nama": "Mie buwohan",
    "pak": 16000,
    "variasi": [],
    "isi": ""
  },
{
    "barcode": "",
    "nama": "Sp Zinc rtg",
    "karton": 91000,
    "variasi": [
      {
        "nama": "Refres c",
        "barcode": "8998866107488",
        "harga": 4600
      }
    ],
    "isi": ""
  },
{
    "barcode": "",
    "nama": "Larutan kaleng anak",
    "karton": 111000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8995227501008",
        "harga": 5000
      }
    ],
    "isi": "24 klg cap kaki 3"
  },
  {
    "barcode": "",
    "nama": "You c1000",
    "karton": 159000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8997009510055",
        "harga": 5500
      }
    ],
    "isi": "30 botol"
  },
  {
    "barcode": "",
    "nama": "Larutan kaleng cap badak",
    "karton": 123000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8999988888842",
        "harga": 5500
      }
    ],
    "isi": "24 klg"
  },
{
    "barcode": "",
    "nama": "Top gelas",
    "karton": 443000,
    "variasi": [
      {
        "nama": "Ecer+gelas",
        "barcode": "8992866800646",
        "harga": 19000
      }
    ],
    "isi": "24 pcs"
  },
  {
    "barcode": "",
    "nama": "Top mini",
    "karton": 133000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866200615",
        "harga": 7000
      }
    ],
    "isi": "20 rtg"
  },
{
    "barcode": "",
    "nama": "Soklin pk",
    "karton": 54500,
    "variasi": [
      {
        "nama": "Fresia peo",
        "barcode": "8998866612616",
        "harga": 5000
      },
      {
        "nama": "Japanes sak",
        "barcode": "8998866612197",
        "harga": 5000
      },
      {
        "nama": "Lav lil",
        "barcode": "8998866803700",
        "harga": 5000
      }
    ],
    "isi": "12 rtg"
  },
  {
    "barcode": "",
    "nama": "Susu rtg",
    "karton": 147000,
    "variasi": [
      {
        "nama": "Coklat",
        "barcode": "8992753102303",
        "harga": 7500
      },
      {
        "nama": "Putih",
        "barcode": "8992753031900",
        "harga": 7500
      }
    ],
    "isi": "20 rtg"
  },
  {
    "barcode": "",
    "nama": "Susu rtg C+Bonus",
    "karton": 151000,
    "variasi": [],
    "isi": "20 rtg+bonus"
  },
  {
    "barcode": "",
    "nama": "Susu rtg P+Bonus",
    "karton": 151000,
    "variasi": [],
    "isi": "20 rtg+bonus"
  },
{
    "barcode": "",
    "nama": "Tp beras rosebrand",
    "karton": 133000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8993093115008",
        "harga": 7000
      }
    ],
    "isi": "20 bksx500gr"
  },
  {
    "barcode": "",
    "nama": "Tp ketan rosebrand",
    "karton": 189000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8993093135006",
        "harga": 9500
      }
    ],
    "isi": "20bksx500gr"
  },
{
    "barcode": "",
    "nama": "Olala milky strawbery",
    "slop": 33500,
    "variasi": [],
    "isi": "24 cup"
  },
  {
    "barcode": "",
    "nama": "Golda",
    "slop": 36000,
    "variasi": [],
    "isi": "12 btl"
  },
  {
    "barcode": "",
    "nama": "Milku",
    "slop": 35000,
    "variasi": [],
    "isi": "12 btl"
  },
{
    "barcode": "",
    "nama": "Aquviva 700ml",
    "slop": 20500,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866632287",
        "harga": 2000
      }
    ],
    "isi": "12 botol"
  },
  {
    "barcode": "",
    "nama": "Marimas",
    "karton": 218000,
    "variasi": [
      {
        "nama": "1 pak/12 rtg",
        "barcode": "",
        "harga": 36500
      },
      {
        "nama": "Jeruk pon",
        "barcode": "8993500019844",
        "harga": 3100
      },
      {
        "nama": "Swe mango",
        "barcode": "749921010162",
        "harga": 3100
      },
      {
        "nama": "Kelapa mud",
        "barcode": "8993500019400",
        "harga": 3100
      },
      {
        "nama": "Jeruk man",
        "barcode": "749921010414",
        "harga": 3100
      },
      {
        "nama": "Jeruk per",
        "barcode": "8993500010162",
        "harga": 3100
      },
      {
        "nama": "Sirsak",
        "barcode": "8993500019943",
        "harga": 3100
      },
      {
        "nama": "Jeruk nip",
        "barcode": "8993500019875",
        "harga": 3100
      },
      {
        "nama": "Pink leci",
        "barcode": "8993500019141",
        "harga": 3100
      },
      {
        "nama": "Cocopandan",
        "barcode": "8993500019417",
        "harga": 3100
      },
      {
        "nama": "Blewah",
        "barcode": "8993500010339",
        "harga": 3100
      }
    ],
    "isi": "6 pak / 72 rtg"
  },
  {
    "barcode": "",
    "nama": "Indomie goreng",
    "karton": 114000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "089686010947",
        "harga": 2900
      }
    ],
    "isi": "40 pcs"
  },
  {
    "barcode": "",
    "nama": "Indomie soto",
    "karton": 109000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "",
        "harga": 2800
      }
    ],
    "isi": "40 pcs"
  },
{
    "barcode": "",
    "nama": "Top white",
    "karton": 129000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866609234",
        "harga": 13000
      }
    ],
    "isi": "10 rtg"
  },
  {
    "barcode": "",
    "nama": "Royko ayam",
    "karton": 211000,
    "variasi": [
      {
        "nama": "1 rtg",
        "barcode": "8999999601331",
        "harga": 4500
      }
    ],
    "isi": "48 rtg"
  },
  {
    "barcode": "",
    "nama": "Royko sapi",
    "karton": 212000,
    "variasi": [
      {
        "nama": "1 rtg",
        "barcode": "8999999601348",
        "harga": 4500
      }
    ],
    "isi": "48 rtg"
  },
{
    "barcode": "",
    "nama": "Top gula aren",
    "karton": 198000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866202626",
        "harga": 17000
      }
    ],
    "isi": "12 rtg"
  },
  {
    "barcode": "",
    "nama": "Rokok galang filter 12",
    "slop": 157000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8997220470176",
        "harga": 16000
      }
    ],
    "isi": "10 bks"
  },
  {
    "barcode": "",
    "nama": "Rokok international",
    "slop": 496000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998989100120",
        "harga": 25000
      }
    ],
    "isi": "20 bks"
  },
{
    "barcode": "",
    "nama": "Rokok galang filter 16",
    "slop": 205000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8997220470206",
        "harga": 21000
      }
    ],
    "isi": "10 bks"
  },
{
    "barcode": "",
    "nama": "Teh sariwangi rtg",
    "karton": 225000,
    "variasi": [
      {
        "nama": "1 rtg",
        "barcode": "8999999540333",
        "harga": 4500
      }
    ],
    "isi": "48 rtg"
  },
{
    "barcode": "",
    "nama": "Teh sariwangi kotak",
    "karton": "263000",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8999999195649",
        "harga": 5500
      }
    ],
    "isi": "48 kotak"
  },
{
    "barcode": "",
    "nama": "Soklin ekonomis",
    "karton": 94500,
    "variasi": [
      {
        "nama": "Peo ros",
        "barcode": "8998866808231",
        "harga": 8000
      }
    ],
    "isi": "12 pcs"
  },
  {
    "barcode": "",
    "nama": "Soklin gm",
    "karton": 98000,
    "variasi": [
      {
        "nama": "Korean c",
        "barcode": "8998866618687",
        "harga": 4100
      },
      {
        "nama": "Velvet orc",
        "barcode": "8998866609494",
        "harga": 4100
      },
      {
        "nama": "Peony ros",
        "barcode": "8998866609487",
        "harga": 4100
      }
    ],
    "isi": "24 pcs"
  },
{
    "barcode": "",
    "nama": "Floridina",
    "karton": 30500,
    "variasi": [
      {
        "nama": "Jeruk",
        "barcode": "",
        "harga": 2700
      },
      {
        "nama": "Kelapa",
        "barcode": "",
        "harga": 2700
      }
    ],
    "isi": "12 botol"
  },
{
    "barcode": "",
    "nama": "Minyak fortune bantal",
    "karton": 218000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998225800012",
        "harga": 18500
      }
    ],
    "isi": "12 pcs"
  },
{
    "barcode": "",
    "nama": "Sek topi",
    "bal": 96000,
    "variasi": [
      {
        "nama": "1 pak(isi 10 tali)",
        "barcode": "",
        "harga": 19000
      },
      {
        "nama": "Ecer",
        "barcode": "",
        "harga": 2000
      }
    ],
    "isi": ""
  },
{
    "barcode": "",
    "nama": "Cengkeh gunting",
    "pak": 102000,
    "variasi": [
      {
        "nama": "ecer lama/tanpa gerigi",
        "barcode": "",
        "harga": 6000
      },
      {
        "nama": "ecer Baru/gerigi",
        "barcode": "",
        "harga": 5500
      },
      {
        "nama": "ecer Beli > 5 baru/gerigi",
        "barcode": "",
        "harga": 5100
      }
    ],
    "isi": "20 pcs"
  },
{
    "barcode": "",
    "nama": "Kecap bango 3000",
    "karton": 112000,
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8999999514006",
        "harga": 2500
      }
    ],
    "isi": "48 pcs"
  },
{
    "barcode": "",
    "nama": "Ekonomi cair 650ml",
    "karton": 81500,
    "variasi": [
    {
        "nama": "Ecer",
        "barcode": "8998866611718",
        "harga": 7000
    }
    ],
    "isi": "12 pcs"
  },
{
    "nama": "Oka sak",
    "barcode": "",
    "satuan": "Sak",
    "sak": "160000",
    "isi": "25kg",
    "variasi": [
      {
        "nama": "1kg",
        "barcode": "",
        "harga": "7000"
      }
    ]
  },
  {
    "nama": "Protex ungu 5p",
    "barcode": "",
    "satuan": "Karton",
    "karton": "109000",
    "isi": "48 pak/4 tas",
    "variasi": [
      {
        "nama": "1 tas",
        "barcode": "",
        "harga": "28000"
      },
      {
        "nama": "1 pcs",
        "barcode": "8998866500128",
        "harga": "2500"
      }
    ]
  },
  {
    "nama": "Rokok gajah filter 12",
    "barcode": "",
    "satuan": "Slop",
    "slop": "166000",
    "isi": "10 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8997018320829",
        "harga": "17000"
      }
    ]
  },
{
    "nama": "Tp lombok",
    "barcode": "",
    "satuan": "Pak",
    "pak": "9000",
    "isi": "10 pcs",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8997030090274",
        "harga": "1000"
      }
    ]
  },
  {
    "nama": "Intermie pedas",
    "barcode": "",
    "satuan": "Karton",
    "karton": "53000",
    "isi": "40 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "089686021004",
        "harga": "1500"
      }
    ]
  },
  {
    barcode: "",
    nama: "sabun giv",
    karton: 182000,
    variasi: [
      { nama: "pepaya", barcode: "8998866608312", harga: 2600 },
      { nama: "hijab tin", barcode: "8998866612890", harga: 2600 },
      { nama: "safron", barcode: "8998866621519", harga: 2600 }
    ],
    isi: "72 pcs"
  },
  {
    "nama": "Rapika 400ml",
    "barcode": "",
    "satuan": "Karton",
    "karton": "42500",
    "isi": "12 pouch",
    "variasi": [
      {
        "nama": "Forever blosom",
        "barcode": "8998866603416",
        "harga": "4000"
      },
      {
        "nama": "Sparkling water",
        "barcode": "8998866605649",
        "harga": "4000"
      }
    ]
  },
{
    barcode: "",
    nama: "gula merah",
    bal: 120000,
    variasi: [
      { nama: "1kg", barcode: "", harga: 15000 },
      { nama: "500gr", barcode: "", harga: 8000 },
      { nama: "250gr", barcode: "", harga: 4500 }
    ],
    isi: "8.5kg"
  },
{
    barcode: "",
    nama: "aqua 600ml",
    karton: 45500,
    variasi: [
      { nama: "ecer", barcode: "", harga: 2000 }
    ],
    isi: "24 btl"
  },
{
    barcode: "",
    nama: "aqua 1,5L",
    karton: 52000,
    variasi: [
      { nama: "ecer", barcode: "", harga: 4500 }
    ],
    isi: "12 btl"
  },
{
    barcode: "",
    nama: "kecap bango rtg",
    karton: 112000,
    variasi: [
      { nama: "rtg", barcode: "8999999533496", harga: 9500 }
    ],
    isi: "12 rtg"
  },
{
    barcode: "",
    nama: "sampo emeron rtg",
    karton: 83000,
    variasi: [
      { nama: "black shine", barcode: "8998866107020", harga: 4000 }
    ],
    isi: "21 rtg"
  },
{
    barcode: "",
    nama: "closeup 75gr",
    karton: 334000,
    variasi: [
      { nama: "ecer", barcode: "8999999574376", harga: 7000 }
    ],
    isi: "48 pcs"
  },
{
    barcode: "",
    nama: "aqua gelas",
    karton: 33000,
    variasi: [
      
    ],
    isi: "48 gls"
  },
  {
    barcode: "",
    nama: "sabun nuvo",
    karton: 178500,
    variasi: [
      { nama: "pink", barcode: "8998866610742", harga: 2700 },
      { nama: "kuning", barcode: "8998866602570", harga: 2700 }
    ],
    isi: "72 pcs"
  },
  {
    barcode: "8999909000995",
    nama: "sampoerna aga",
    slop: 156000,
    variasi: [
      { nama: "ecer", barcode: "8999909000988", harga: 16000 }
    ],
    isi: "10 bungkus"
  },
   {
    barcode: "",
    nama: "tp tulip",
    sak: 166000,
    variasi: [
      { nama: "1kg", barcode: "", harga: 7000 }
    ],
    isi: "25kg"
  },
    {
    barcode: "",
    nama: "gula",
    sak: 743000,
    variasi: [
      { nama: "1kg", barcode: "", harga: 15500 }
    ],
    isi: "50kg"
  },
    {
    barcode: "",
    nama: "kecap sedap rtg merah",
    karton: 79000,
    variasi: [
      { nama: "2 rt+box", barcode: "", harga: 10500 },
      { nama: "1 rtg", barcode: "8998866609647", harga: 5250 }
    ],
    isi: "16 rtg"
  },
      {
    barcode: "",
    nama: "rokok alami",
    slop: 94500,
    variasi: [
      { nama: "ecer", barcode: "8990111211001", harga: 9500 }
    ],
    isi: "10 bungkus"
  },
  {
    barcode: "8999090502032",
    nama: "rokok sukun ex 12",
    slop: 200000,
    variasi: [
      { nama: "ecer", barcode: "8999090501035", harga: 20000 }
    ],
    isi: "10 bungkus"
  },
  {
    barcode: "",
    nama: "Minyak kita botol",
    karton: 197000,
    variasi: [
      { nama: "ecer", barcode: "8997013450415", harga: 16500 }
    ],
    isi: "12 btl"
  },
  {
    barcode: "",
    nama: "sedap cup ayam jerit",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866202930", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup soto",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866200837", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup baso bleduk",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866203258", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup baso spesial",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866200851", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup kari spesial",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866200844", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup ayam nampol",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866203807", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup singapore spicy laksa",
    karton: 47000,
    variasi: [
      { nama: "ecer", barcode: "8998866204460", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup kari mercon",
    karton: 45000,
    variasi: [
      { nama: "ecer", barcode: "8998866204156", harga: 4000 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup korean spicy chicken",
    karton: 50500,
    variasi: [
      { nama: "ecer", barcode: "8998866202404", harga: 4300 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup korean spicy soup",
    karton: 49000,
    variasi: [
      { nama: "ecer", barcode: "8998866202671", harga: 4200 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "sedap cup goreng",
    karton: 50500,
    variasi: [
      { nama: "ecer", barcode: "8998866200813", harga: 4300 }
    ],
    isi: "12 cup"
  },
  {
    barcode: "",
    nama: "kapal api mini",
    karton: 181000,
    variasi: [
      { nama: "1 rtg", barcode: "8991002105584", harga: 9500 },
      { nama: "10 rtg", barcode: "", harga: 92000 }
    ],
    isi: "20 rtg"
  },
  {
    barcode: "",
    nama: "sabun fres box",
    karton: 182000,
    variasi: [
      { nama: "pink", barcode: "8998866604512", harga: 10500 },
      { nama: "biru", barcode: "8998866800204", harga: 10500 }
    ],
    isi: "18 pak"
  },
  {
    barcode: "",
    nama: "mama lemon 2000",
    karton: 32000,
    variasi: [
      { nama: "ecer", barcode: "8998866105132", harga: 1500 }
    ],
    isi: "24 pcs"
  },
  {
    barcode: "",
    nama: "ekonomi colek",
    karton: 50000,
    variasi: [
      { nama: "ecer", barcode: "8998866600095", harga: 1700 }
    ],
    isi: "30 pcs"
  },
  {
    barcode: "",
    nama: "ekonomi cair 2000",
    karton: 37000,
    variasi: [
      { nama: "3 pcs nanas", barcode: "8998866627399", harga: 3500 },
      { nama: "3 pcs nipis", barcode: "8998866611701", harga: 3500 }
    ],
    isi: "36 pcs"
  },
  {
    barcode: "",
    nama: "kecap sedap 2000 hijau",
    karton: 55000,
    variasi: [
      { nama: "ecer", barcode: "8998866202275", harga: 1300 }
    ],
    isi: "48 pcs"
  },
  {
    barcode: "",
    nama: "mie sedap soto",
    karton: 105000,
    variasi: [
      { nama: "ecer", barcode: "8998866200325", harga: 2700 }
    ],
    isi: "40 pcs"
  },
  {
    barcode: "",
    nama: "mie sedap ayam bawang",
    karton: 105000,
    variasi: [
      { nama: "ecer", barcode: "8998866200318", harga: 2700 }
    ],
    isi: "40 pcs"
  },
  {
    barcode: "",
    nama: "mie sedap goreng",
    karton: 110000,
    variasi: [
      { nama: "ecer", barcode: "8998866200301", harga: 2800 }
    ],
    isi: "40 pcs"
  },
  {
    barcode: "",
    nama: "mie sedap korean spicy chicken",
    karton: 109000,
    variasi: [
      { nama: "ecer", barcode: "8998866202343", harga: 2800 }
    ],
    isi: "40 pcs"
  },
  {
    barcode: "8999909012554",
    nama: "sampoerna aga hitam/prima",
    slop: 150000,
    variasi: [
      { nama: "ecer", barcode: "8999909012547", harga: 15500 }
    ],
    isi: "10 bks"
  },
  {
    barcode: "",
    nama: "rokok bit 16",
    slop: 90000,
    variasi: [
      { nama: "ecer", barcode: "8991915102502", harga: 9500 }
    ],
    isi: "10 bks"
  },
  {
    barcode: "8999090522641",
    nama: "sukun hijau",
    slop: 112000,
    variasi: [
      { nama: "ecer", barcode: "8999090102157", harga: 11500 }
    ],
    isi: "10 bks"
  },
  {
    barcode: "",
    nama: "masako sapi",
    karton: 260500,
    variasi: [
      { nama: "rtg", barcode: "8992770033147", harga: 4500 }
    ],
    isi: "60 rtg"
  },
  {
    barcode: "",
    nama: "masako ayam",
    karton: 260000,
    variasi: [
      { nama: "rtg", barcode: "8992770033130", harga: 4500 }
    ],
    isi: "60 rtg"
  },
  {
    barcode: "",
    nama: "sasa 5000",
    karton: 341000,
    variasi: [
      { nama: "ecer", barcode: "8991188943369", harga: 4500 }
    ],
    isi: "80 bks"
  },
  {
    barcode: "",
    nama: "minyak kita refil",
    karton: 197000,
    variasi: [
      { nama: "ecer", barcode: "8997222860722", harga: 16500 }
    ],
    isi: "12 pcs"
  },
  
  {
    "nama": "Merica",
    "barcode": "",
    "satuan": "1 kg",
    "bal": "165000",
    "isi": "1 kg",
    "variasi": [
      {
        "nama": "500gr",
        "barcode": "",
        "harga": "83000"
      },
      {
        "nama": "100gr",
        "barcode": "",
        "harga": "17000"
      }
    ]
  },
  {
    "nama": "Teh pucuk",
    "barcode": "",
    "satuan": "Karton",
    "karton": "58500",
    "isi": "24 btl",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8996001600146",
        "harga": "2500"
      }
    ]
  },
  {
    "nama": "Ichi ocha",
    "barcode": "",
    "karton": "50000",
    "isi": "24 btl",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "089686821086",
        "harga": "2500"
      }
    ]
  },
  {
    "nama": "Teh rio",
    "barcode": "",
    "satuan": "Karton",
    "karton": "19000",
    "isi": "24 cup",
    "variasi": []
  },
  {
    "nama": "Alahya gelas",
    "barcode": "",
    "satuan": "Karton",
    "karton": "14500",
    "isi": "48 gelas",
    "variasi": [
      {
        "nama": "Beli < 5",
        "barcode": "",
        "harga": "14000"
      }
    ]
  },
  {
    "nama": "Mie sedap ayam jerit",
    "barcode": "",
    "satuan": "Karton",
    "karton": "108000",
    "isi": "40 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866626842",
        "harga": "2800"
      }
    ]
  },
  {
    "nama": "Mie sedap soto madura",
    "barcode": "",
    "satuan": "Karton",
    "karton": "108000",
    "isi": "40 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866203401",
        "harga": "2800"
      }
    ]
  },
  {
    "nama": "Mie sedap goreng salero padang",
    "barcode": "",
    "satuan": "Karton",
    "karton": "113500",
    "isi": "40 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866202770",
        "harga": "2900"
      }
    ]
  },
  {
    "nama": "Mie sedap ayam spesial",
    "barcode": "",
    "satuan": "Karton",
    "karton": "99500",
    "isi": "40 bks",
    "variasi": [
      {
        "nama": "Ecer",
        "barcode": "8998866200509",
        "harga": "2600"
      }
    ]
  }
];

let keranjang = [];
let riwayat = JSON.parse(localStorage.getItem("riwayatTransaksi") || "[]");

function toggleRiwayat() {
  const box = document.getElementById("riwayatBox");
  const btn = document.getElementById("btnRiwayat");

  if (box.style.display === "none") {
    box.style.display = "block";
    btn.textContent = "Tutup Riwayat";
  } else {
    box.style.display = "none";
    btn.textContent = "Riwayat Transaksi";
  }
}

const bulkKeys = [
  {key:"karton", label:"Karton", badge:"badge-karton"},
  {key:"slop",   label:"Slop",   badge:"badge-slop"},
  {key:"pak",    label:"Pak",    badge:"badge-pak"},
  {key:"sak",    label:"Sak",    badge:"badge-sak"},
  {key:"bal",    label:"Bal",    badge:"badge-bal"}
];

// === Suara ===
const suaraScan = document.getElementById("suaraScan");
const suaraGagal = document.getElementById("suaraGagal");
function playSuara(el) {
  try {
    el.currentTime = 0;
    el.play();
  } catch (e) {
    // beberapa browser/permission mungkin blok, tetap lanjut
    console.warn("Suara tidak bisa diputar:", e);
  }
}

function formatRupiah(n) {
  if (!n && n !== 0) return "0";
  return Number(n).toLocaleString('id-ID');
}

function formatUangPembeli(el) {
  let angka = el.value.replace(/\D/g, "");
  if (angka === "") {
    el.value = "";
    hitungKembalian();
    return;
  }
  el.value = Number(angka).toLocaleString("id-ID");
  hitungKembalian();
}

function renderUangRekomendasi() {
  const total = keranjang.reduce((sum, i) => sum + i.harga * i.qty, 0);
  const rekomendasi = [];
  const nominalDasar = [50000, 100000, 200000, 500000];
  nominalDasar.forEach(n => { if (n >= total) rekomendasi.push(n); });

  const div = document.getElementById("uangRekomendasi");
  div.innerHTML = "";
  rekomendasi.forEach(n => {
    const btn = document.createElement("button");
    btn.textContent = "Rp " + formatRupiah(n);
    btn.onclick = () => {
      document.getElementById("uangPembeli").value = formatRupiah(n);
      hitungKembalian();
    };
    div.appendChild(btn);
  });
}

// === Notifikasi fade in / fade out ===
const notifContainer = document.getElementById("notifContainer");
/**
 * showNotif(message, type="info", duration=2500)
 * type: "success" | "error" | "info"
 */
function showNotif(message, type="info", duration=2500) {
  const div = document.createElement("div");
  div.className = "notif " + type;
  const icon = document.createElement("div");
  icon.className = "icon";
  icon.textContent = type === "success" ? "✓" : (type === "error" ? "✕" : "i");
  const txt = document.createElement("div");
  txt.innerHTML = message;
  div.appendChild(icon);
  div.appendChild(txt);

  notifContainer.appendChild(div);

  // otomatis menghapus setelah duration (tambah animasi fade-out)
  setTimeout(() => {
    div.classList.add("fade-out");
    // setelah anim selesai, remove
    div.addEventListener("animationend", () => {
      if (div.parentNode) div.parentNode.removeChild(div);
    });
  }, duration);
}

// === HASIL PENCARIAN ===
function renderHasilCari(filter="") {
  const tbody = document.querySelector("#tabelHasil tbody");
  tbody.innerHTML = "";
  if (filter.trim() === "") return; 

  produkDB.forEach(p => {
    if(p.nama.toLowerCase().includes(filter.toLowerCase())) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><b>${p.nama}</b></td><td></td><td></td>`;
      tbody.appendChild(tr);

      p.variasi.forEach(v => {
        if(v.nama.toLowerCase().includes(filter.toLowerCase()) || p.nama.toLowerCase().includes(filter.toLowerCase())) {
          const trVarian = document.createElement("tr");
          trVarian.className = "produk-varian";
          trVarian.innerHTML = `
            <td style="padding-left:25px;">${v.nama} <span class="badge badge-ecer">Ecer</span></td>
            <td>Rp ${formatRupiah(v.harga)}</td>
            <td><button onclick="tambahKeranjang('${p.nama}','${v.nama}','ecer',${v.harga})">Tambah</button></td>`;
          tbody.appendChild(trVarian);
        }
      });

      bulkKeys.forEach(bk => {
        if (typeof p[bk.key] !== "undefined") {
          const hargaBulk = p[bk.key];
          const labelIsi = p.isi ? ` (isi ${p.isi})` : '';
          const trVarian = document.createElement("tr");
          trVarian.className = "produk-varian";
          trVarian.innerHTML = `
            <td style="padding-left:25px;">${bk.label}${labelIsi} <span class="badge ${bk.badge}">${bk.label}</span></td>
            <td>Rp ${formatRupiah(hargaBulk)}</td>
            <td><button onclick="tambahKeranjang('${p.nama}','${bk.label}${labelIsi}','${bk.key}',${hargaBulk})">Tambah</button></td>`;
          tbody.appendChild(trVarian);
        }
      });
    }
  });
}

// === KERANJANG ===
function renderKeranjang() {
  const tbody = document.querySelector("#tabelKeranjang tbody");
  tbody.innerHTML = "";
  let total = 0;
  keranjang.forEach((item, index) => {
    const itemTotal = Number(item.harga) * Number(item.qty || 0);
    total += itemTotal;
    let badgeClass = "badge-ecer", badgeText = "Ecer";
    const found = bulkKeys.find(b => b.key === item.jenis);
    if(found){ badgeClass = found.badge; badgeText = found.label; }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.nama}</td>
      <td>${item.varian} <span class="badge ${badgeClass}">${badgeText}</span></td>
      <td>Rp ${formatRupiah(item.harga)}</td>
      <td><input type="number" min="1" value="${item.qty}" onchange="ubahQty(${index}, this.value)"></td>
      <td>Rp ${formatRupiah(itemTotal)}</td>
      <td><button onclick="hapusItem(${index})">Hapus</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("totalBelanja").textContent = formatRupiah(total);
  renderUangRekomendasi();
  hitungKembalian();
}

function tambahKeranjang(nama, varian, jenis, harga) {
  harga = Number(harga);
  varian = varian.replace(/\(isi.*?\)/gi, "").trim();
  const index = keranjang.findIndex(i => i.nama === nama && i.varian === varian && i.jenis === jenis);

  if (index > -1) {
    // Ambil item lama, tambah qty, lalu pindah ke atas
    let item = keranjang.splice(index, 1)[0];
    item.qty++;
    keranjang.unshift(item);
  } else {
    // Item baru langsung ke atas
    keranjang.unshift({ nama, varian, jenis, harga, qty: 1 });
  }

  renderKeranjang();
  showNotif(`${nama} ${varian ? "- " + varian : ""} ditambahkan`, "success", 2000);
}


function hapusItem(i) { 
  const removed = keranjang.splice(i, 1)[0];
  renderKeranjang(); 
  if (removed) showNotif(`${removed.nama} ${removed.varian} dihapus`, "info", 1800);
}
function ubahQty(i, val) { const qty = parseInt(val); keranjang[i].qty = (isNaN(qty) || qty < 1) ? 1 : qty; renderKeranjang(); showNotif("Jumlah diperbarui", "info", 1200); }

function hitungKembalian() {
  const total = keranjang.reduce((sum, i) => sum + i.harga * i.qty, 0);
  const uangInput = document.getElementById("uangPembeli").value.replace(/\D/g, "");
  const uang = parseInt(uangInput) || 0;
  const kembali = uang - total;
  document.getElementById("kembalian").textContent = formatRupiah(kembali >= 0 ? kembali : 0);
}

// === CETAK NOTA ===
const encoder = new TextEncoder();
async function cetakNota() {
  if (keranjang.length === 0) { showNotif("Keranjang masih kosong!", "error", 2200); return; }
  let nota = "=== WPA MARKET ===\n" + new Date().toLocaleString("id-ID") + "\n------------------------------\n";
  keranjang.forEach(i => {
    nota += `${i.nama} - ${i.varian}\n`;
    const qtyStr = String(i.qty).padStart(3, " ");
    const hargaStr = ("" + formatRupiah(i.harga)).padStart(3, " ");
    const totalStr = ("" + formatRupiah(i.harga * i.qty)).padStart(12, " ");
    nota += `${qtyStr} x ${hargaStr}  ${totalStr}\n`;
  });
  nota += "------------------------------\n";
  nota += "Total   : " + document.getElementById("totalBelanja").textContent + "\n";
  nota += "Uang    : " + (document.getElementById("uangPembeli").value || "0") + "\n";
  nota += "Kembali : " + document.getElementById("kembalian").textContent + "\n";
  nota += "------------------------------\nwa : 0852 3480 3820\n\n\n";

  const transaksi = {
    tanggal: new Date().toLocaleString("id-ID"),
    total: document.getElementById("totalBelanja").textContent,
    uang: document.getElementById("uangPembeli").value || "0",
    kembali: document.getElementById("kembalian").textContent,
    detail: [...keranjang]
  };
  riwayat.push(transaksi);
  localStorage.setItem("riwayatTransaksi", JSON.stringify(riwayat));
  renderRiwayat();

  try {
    // coba cetak via USB (WebUSB)
    const device = await navigator.usb.requestDevice({ filters: [{}] });
    await device.open();
    if (device.configuration === null) await device.selectConfiguration(1);
    const iface = device.configuration.interfaces[0];
    await device.claimInterface(iface.interfaceNumber);
    let endpointOut = null;
    iface.alternates[0].endpoints.forEach(ep => { if (ep.direction === "out") endpointOut = ep.endpointNumber; });
    if (endpointOut === null) throw new Error("Endpoint OUT tidak ditemukan");
    const data = encoder.encode(nota);
    await device.transferOut(endpointOut, data);
    showNotif("Nota berhasil dicetak via USB!", "success", 2500);
  } catch (err) {
    // tampilkan notif error (tetap simpan transaksi)
    showNotif("Gagal mencetak: " + (err && err.message ? err.message : err), "error", 3500);
    console.warn(err);
  }

  keranjang = [];
  renderKeranjang();
  document.getElementById("uangPembeli").value = "";
  document.getElementById("cariProduk").focus();
}

// === RIWAYAT ===
function renderRiwayat() {
  const tbody = document.querySelector("#tabelRiwayat tbody");
  tbody.innerHTML = "";
  for (let i = riwayat.length - 1; i >= 0; i--) {
    const r = riwayat[i];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.tanggal}</td>
      <td>Rp ${r.total}</td>
      <td>Rp ${r.uang}</td>
      <td>Rp ${r.kembali}</td>
      <td>
        <button onclick="lihatDetail(${i})">Lihat</button>
        <button onclick="editTransaksi(${i})">Edit</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function lihatDetail(i) {
  const r = riwayat[i];
  let detail = `=== Transaksi ===\n${r.tanggal}\n\n`;
  r.detail.forEach(d => {
    detail += `${d.nama} - ${d.varian}\n${d.qty} x Rp${formatRupiah(d.harga)} = Rp${formatRupiah(d.harga*d.qty)}\n`;
  });
  detail += `\nTotal: Rp ${r.total}\nUang: Rp ${r.uang}\nKembali: Rp ${r.kembali}\n`;
  alert(detail);
}

function editTransaksi(i) {
  keranjang = JSON.parse(JSON.stringify(riwayat[i].detail));
  renderKeranjang();
  document.getElementById("uangPembeli").value = riwayat[i].uang;
  hitungKembalian();
  showNotif("Transaksi dimuat ke keranjang (edit).", "info", 1800);
}

// === Event listener ===
const inputCari = document.getElementById("cariProduk");
inputCari.addEventListener("input", e => { renderHasilCari(e.target.value); });

// ✅ Scan pakai Enter
inputCari.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const val = e.target.value.trim();
    if (val === "") return;
    renderHasilCari(val);

    const produk = produkDB.find(p => p.barcode === val || p.variasi.some(v => v.barcode === val));
    if (produk) {
      let varian = produk.variasi.find(v => v.barcode === val);
      if (varian) {
        tambahKeranjang(produk.nama, varian.nama, "ecer", varian.harga);
      } else {
        // jika scan barcode karton/pack yang ada di produk.barcode -> fallback
        // cari yang matching produk.barcode; kalau tidak ada, coba add bulk default (karton) jika tersedia
        const bulk = bulkKeys.find(bk => typeof produk[bk.key] !== "undefined");
        if (bulk) {
          const hargaBulk = produk[bulk.key];
          tambahKeranjang(produk.nama, bulk.label + (produk.isi ? ` (isi ${produk.isi})` : ""), bulk.key, hargaBulk);
        } else {
          tambahKeranjang(produk.nama, "", "ecer", produk.variasi[0]?.harga || 0);
        }
      }
      playSuara(suaraScan); // ✅ Suara berhasil
      showNotif("Scan berhasil — produk ditambahkan.", "success", 1600);
    } else {
      playSuara(suaraGagal); // ❌ Suara gagal
      showNotif("Barcode/produk tidak ditemukan.", "error", 2200);
    }
    e.target.value = "";
  }
});

renderRiwayat();
</script>

</body>
</html>
